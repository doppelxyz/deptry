name: Build and Release Wheels

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux x86_64 - most common for CI
          - os: ubuntu-24.04
            target: x86_64
            platform: linux
            manylinux: auto
          # macOS x86_64 and aarch64 (M1/M2)
          - os: macos-15
            target: x86_64
            platform: macos
          - os: macos-15
            target: aarch64
            platform: macos

    steps:
      - name: Check out
        uses: actions/checkout@v6

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            echo "ERROR: This workflow must be triggered by a tag (e.g., v0.24.0)"
            exit 1
          fi
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}+doppel" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}+doppel"

      - name: Update version in pyproject.toml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i.bak "s/^version = .*/version = \"${VERSION}\"/" pyproject.toml
          echo "Updated version to: ${VERSION}"
          grep "^version = " pyproject.toml

      - name: Install Python
        uses: actions/setup-python@v6
        id: setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheels (Linux)
        if: matrix.platform == 'linux'
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --interpreter python${{ env.PYTHON_VERSION }}
          sccache: 'true'

      - name: Build wheels (macOS)
        if: matrix.platform == 'macos'
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter ${{ steps.setup-python.outputs.python-path }}
          sccache: 'true'

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform }}-${{ matrix.target }}
          path: dist/*.whl
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [build-wheels]
    steps:
      - name: Check out
        uses: actions/checkout@v6

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            echo "ERROR: This workflow must be triggered by a tag (e.g., v0.24.0)"
            exit 1
          fi
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/v}+doppel" >> $GITHUB_OUTPUT

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: wheels
          pattern: wheels-*
          merge-multiple: true

      - name: List wheels
        run: ls -lah wheels/

      - name: Generate package index
        run: |
          # Create index directory structure
          mkdir -p index/deptry

          # Generate root index
          cat > index/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Simple Index</title></head>
          <body>
              <a href="deptry/">deptry</a><br/>
          </body>
          </html>
          EOF

          # Generate package index with links to release wheels
          TAG="${{ steps.version.outputs.tag }}"
          cat > index/deptry/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Links for deptry</title></head>
          <body>
              <h1>Links for deptry</h1>
          EOF
          for wheel in wheels/*.whl; do
            wheel_name=$(basename "$wheel")
            echo "    <a href=\"https://github.com/doppelxyz/deptry/releases/download/${TAG}/${wheel_name}\">${wheel_name}</a><br/>" >> index/deptry/index.html
          done
          echo "  </body></html>" >> index/deptry/index.html

          cat index/index.html
          echo "---"
          cat index/deptry/index.html

      - name: Commit index to repository
        run: |
          # Find which branch contains this tag
          BRANCH=$(git branch -r --contains ${{ github.sha }} | grep -v HEAD | head -1 | sed 's/.*origin\///')
          echo "Tag is on branch: ${BRANCH}"

          # Check out the branch
          git fetch origin ${BRANCH}
          git checkout ${BRANCH}

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add and commit changes
          git add index/
          git commit -m "Update package index for ${{ steps.version.outputs.tag }}" || echo "No changes to commit"

          # Push back to the same branch
          git push origin ${BRANCH}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Deptry ${{ steps.version.outputs.version }} (Doppel Fork)
          body: |
            **Pre-built wheels** for deptry ${{ steps.version.outputs.version }} (Doppel fork with UV workspace support).

            **Commit:** ${{ github.sha }}
            **Built on:** ${{ github.run_id }}

            ## Installation

            Add to your `pyproject.toml`:
            ```toml
            [[tool.uv.index]]
            name = "doppel-deptry"
            url = "https://github.com/doppelxyz/deptry/releases/download/${{ steps.version.outputs.tag }}/simple/"
            explicit = true

            [tool.uv.sources]
            deptry = { index = "doppel-deptry" }
            ```

            ## Wheels Available

            UV will automatically select the correct wheel for your platform:
            - Linux x86_64
            - macOS x86_64 (Intel)
            - macOS aarch64 (Apple Silicon)
          files: wheels/*.whl
          draft: false
          prerelease: true
          generate_release_notes: false
